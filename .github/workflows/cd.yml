name: CD

on:
  push:
    branches: [main]
    tags: ["v*"]

# Prevent overlapping deployments to the same environment
concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: "20"

permissions:
  contents: read

jobs:
  check-secrets:
    name: Check Required Secrets
    runs-on: ubuntu-latest
    outputs:
      can-deploy: ${{ steps.check.outputs.can-deploy }}
    steps:
      - name: Verify Vercel secrets
        id: check
        run: |
          if [ -n "${{ secrets.VERCEL_TOKEN }}" ] && \
             [ -n "${{ secrets.VERCEL_ORG_ID }}" ] && \
             [ -n "${{ secrets.VERCEL_PROJECT_ID }}" ]; then
            echo "can-deploy=true" >> "$GITHUB_OUTPUT"
            echo "✅ All required Vercel secrets are configured"
          else
            echo "can-deploy=false" >> "$GITHUB_OUTPUT"
            echo "⚠️ Missing one or more Vercel secrets — skipping deploy"
          fi

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: check-secrets
    if: needs.check-secrets.outputs.can-deploy == 'true'
    environment: staging
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci
      - name: Deploy to Vercel (Staging)
        id: deploy-staging
        run: |
          npx vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
          npx vercel build --token=${{ secrets.VERCEL_TOKEN }}
          DEPLOY_URL=$(npx vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "deploy-url=$DEPLOY_URL" >> "$GITHUB_OUTPUT"
          echo "✅ Deployed to: $DEPLOY_URL"
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

  smoke-test-staging:
    name: Smoke Test Staging
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: deploy-staging
    steps:
      - name: Health check
        run: |
          STAGING_URL="${{ vars.STAGING_URL }}"
          if [ -z "$STAGING_URL" ]; then
            echo "⚠️ STAGING_URL not configured — skipping smoke test"
            exit 0
          fi
          MAX_RETRIES=8
          RETRY_DELAY=10
          for i in $(seq 1 $MAX_RETRIES); do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$STAGING_URL/api/health" || true)
            if [ "$STATUS" = "200" ] || [ "$STATUS" = "503" ]; then
              echo "✅ Staging is reachable (HTTP $STATUS) on attempt $i"
              exit 0
            fi
            echo "⏳ Attempt $i/$MAX_RETRIES: HTTP $STATUS, retrying in ${RETRY_DELAY}s..."
            sleep "$RETRY_DELAY"
            # Exponential back-off: 10s, 15s, 22s, ...
            RETRY_DELAY=$(( RETRY_DELAY + RETRY_DELAY / 2 ))
          done
          echo "❌ Staging health check failed after $MAX_RETRIES attempts"
          exit 1

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: smoke-test-staging
    if: startsWith(github.ref, 'refs/tags/v')
    environment: production
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci
      - name: Deploy to Vercel (Production)
        run: |
          npx vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
          npx vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
          npx vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [deploy-staging, smoke-test-staging, deploy-production]
    if: failure()
    steps:
      - name: Report deployment failure
        run: |
          echo "::error::❌ CD pipeline failed for ref ${{ github.ref }} (commit ${{ github.sha }})"
          echo "Failed workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
