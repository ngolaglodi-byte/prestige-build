name: CD

on:
  push:
    branches: [main]
    tags: ["v*"]

env:
  NODE_VERSION: "20"

jobs:
  check-secrets:
    name: Check Required Secrets
    runs-on: ubuntu-latest
    outputs:
      can-deploy: ${{ steps.check.outputs.can-deploy }}
    steps:
      - name: Verify Vercel secrets
        id: check
        run: |
          if [ -n "${{ secrets.VERCEL_TOKEN }}" ] && \
             [ -n "${{ secrets.VERCEL_ORG_ID }}" ] && \
             [ -n "${{ secrets.VERCEL_PROJECT_ID }}" ]; then
            echo "can-deploy=true" >> "$GITHUB_OUTPUT"
            echo "✅ All required Vercel secrets are configured"
          else
            echo "can-deploy=false" >> "$GITHUB_OUTPUT"
            echo "⚠️ Missing one or more Vercel secrets — skipping deploy"
          fi

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: check-secrets
    if: needs.check-secrets.outputs.can-deploy == 'true'
    environment: staging
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci
      - name: Deploy to Vercel (Staging)
        run: |
          npx vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
          npx vercel build --token=${{ secrets.VERCEL_TOKEN }}
          npx vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

  smoke-test-staging:
    name: Smoke Test Staging
    runs-on: ubuntu-latest
    needs: deploy-staging
    steps:
      - name: Health check
        run: |
          STAGING_URL="${{ vars.STAGING_URL }}"
          if [ -z "$STAGING_URL" ]; then
            echo "⚠️ STAGING_URL not configured — skipping smoke test"
            exit 0
          fi
          for i in 1 2 3 4 5; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$STAGING_URL/api/health" || true)
            if [ "$STATUS" = "200" ] || [ "$STATUS" = "503" ]; then
              echo "✅ Staging is reachable (HTTP $STATUS)"
              exit 0
            fi
            echo "Attempt $i: status $STATUS, retrying in 15s..."
            sleep 15
          done
          echo "❌ Staging health check failed"
          exit 1

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: smoke-test-staging
    if: startsWith(github.ref, 'refs/tags/v')
    environment: production
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci
      - name: Deploy to Vercel (Production)
        run: |
          npx vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
          npx vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
          npx vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
